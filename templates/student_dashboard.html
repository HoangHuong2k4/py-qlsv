<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard sinh vi√™n</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/login.css">
</head>
<body>
  <!-- Header Banner -->
  <div id="header">
    <div id="banner"></div>
  </div>

  <!-- Navigation Tabs -->
  <div class="nav-tabs">
    <div class="nav-container">
      <a href="/study-plan" class="nav-tab">K·∫ø ho·∫°ch h·ªçc t·∫≠p</a>
      <a href="/dashboard" class="nav-tab active">G·ª£i √Ω m√¥n h·ªçc</a>
      <a href="/profile" class="nav-tab">Th√¥ng tin c√° nh√¢n</a>
      <a href="/logout" class="nav-tab logout-tab">ƒêƒÉng xu·∫•t</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h1 style="margin: 0;">H·ªçc ph·∫ßn c·ªßa {{ student_id }}</h1>
      <a href="{{ url_for('study_plan') }}" class="btn" style="background: #2196F3;">
        üìö Xem 5 K·∫ø Ho·∫°ch H·ªçc T·∫≠p
      </a>
    </div>

    {% if credit_summary %}
    <section class="card" style="background-color: #f0f8ff; border-left: 4px solid #4CAF50;">
      <h2>üìä T·ªïng quan t√≠n ch·ªâ</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div>
          <strong>ƒê√£ t√≠ch l≈©y:</strong><br>
          <span style="font-size: 1.5em; color: #4CAF50;">{{ credit_summary.earned }}</span> / {{ credit_summary.required }} t√≠n ch·ªâ
        </div>
        <div>
          <strong>C√≤n l·∫°i:</strong><br>
          <span style="font-size: 1.5em; color: #ff9800;">{{ credit_summary.remaining }}</span> t√≠n ch·ªâ
        </div>
        <div>
          <strong>Ti·∫øn ƒë·ªô:</strong><br>
          <span style="font-size: 1.5em; color: #2196F3;">{{ credit_summary.percentage }}%</span>
        </div>
      </div>
      <p style="margin-top: 1rem; color: #666; font-size: 0.9em;">
        <em>M·ª•c ti√™u: Ho√†n th√†nh 156 t√≠n ch·ªâ trong 4.5 nƒÉm (9 h·ªçc k·ª≥) - Trung b√¨nh ~17.3 t√≠n ch·ªâ/h·ªçc k·ª≥</em>
      </p>
      
      <!-- Bi·ªÉu ƒë·ªì t√≠n ch·ªâ theo h·ªçc k·ª≥ -->
      <div style="margin-top: 2rem;">
        <h3 style="color: #1f5ca9; margin-bottom: 1rem;">üìä Bi·ªÉu ƒë·ªì t√≠n ch·ªâ theo h·ªçc k·ª≥</h3>
        <canvas id="creditsChart" style="max-height: 300px;"></canvas>
      </div>
    </section>
    {% endif %}

    <section class="card">
      <h2>M√¥n ƒë√£ h·ªçc / ti·∫øn tr√¨nh</h2>
      {% if courses %}
      <table>
        <thead>
          <tr><th>M√£ m√¥n</th><th>T√™n m√¥n h·ªçc</th><th>NƒÉm</th><th>H·ªçc k·ª≥</th><th>S·ªë t√≠n ch·ªâ</th><th>Tr·∫°ng th√°i</th><th>ƒêi·ªÉm</th></tr>
        </thead>
        <tbody>
          {% for c in courses %}
          <tr>
            <td>{{ c.CourseCode }}</td>
            <td>{{ c.CourseName }}</td>
            <td>{{ c.Year }}</td>
            <td>{{ c.Semester }}</td>
            <td>{{ c.Credits }}</td>
            <td>{{ c.Status }}</td>
            <td>{{ c.Score }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="muted">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ªçc ph·∫ßn cho sinh vi√™n n√†y.</p>
      {% endif %}
    </section>

    {# T√°ch th√†nh c√°c nh√≥m #}
    {% if recs %}
      {% set thesis_recs = [] %}
      {% set additional_recs = [] %}
      {% set other_recs = [] %}
      {% for r in recs %}
        {% if (r.get('CourseCode') == 'CT555') and (r.get('recommended_year') == 5) and (r.get('recommended_semester') == 1) %}
          {% if thesis_recs.append(r) %}{% endif %}
        {% elif (r.get('recommended_year') == 5) and (r.get('recommended_semester') == 1) and (r.get('CourseCode') != 'CT555') %}
          {% if additional_recs.append(r) %}{% endif %}
        {% else %}
          {% if other_recs.append(r) %}{% endif %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% set thesis_recs = [] %}
      {% set additional_recs = [] %}
      {% set other_recs = [] %}
    {% endif %}

    {% if thesis_recs %}
    <section class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">üéì G·ª£i √Ω lu·∫≠n vƒÉn t·ªët nghi·ªáp (H·ªçc k·ª≥ 1 nƒÉm 5)</h2>
        <a href="{{ url_for('download_recommendations') }}" class="btn" style="background: #4CAF50;">
          üì• T·∫£i g·ª£i √Ω
        </a>
      </div>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 1em;">
        <em>G·ª£i √Ω cho sinh vi√™n ƒë√£ g·∫ßn ƒë·ªß 156 t√≠n ch·ªâ - ch·ªâ c·∫ßn th√™m lu·∫≠n vƒÉn t·ªët nghi·ªáp</em>
      </p>
      <table>
        <thead>
          <tr>
            <th>M√£ m√¥n</th>
            <th>T√™n m√¥n h·ªçc</th>
            <th>T√≠n ch·ªâ</th>
            <th>NƒÉm h·ªçc</th>
            <th>H·ªçc k·ª≥</th>
            <th>ƒêi·ªÉm TB</th>
            <th>T·ª∑ l·ªá ƒë·∫≠u</th>
            <th>L√Ω do g·ª£i √Ω</th>
          </tr>
        </thead>
        <tbody>
          {% for r in thesis_recs %}
          <tr>
            <td><strong>{{ r.CourseCode }}</strong></td>
            <td>{{ r.CourseName }}</td>
            <td>{{ r.Credits }}</td>
            <td><strong>NƒÉm {{ r.recommended_year }}</strong></td>
            <td><strong>HK{{ r.recommended_semester }}</strong></td>
            <td>
              {% if r.avg_score %}
                {{ "%.2f"|format(r.avg_score) }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if r.pass_rate %}
                {{ "%.1f"|format(r.pass_rate) }}%
              {% else %}
                -
              {% endif %}
            </td>
            <td style="font-size: 0.9em; color: #555;">
              {% if r.recommendation_reason %}
                {{ r.recommendation_reason }}
              {% else %}
                G·ª£i √Ω d·ª±a tr√™n sinh vi√™n t∆∞∆°ng t·ª±
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
    {% endif %}

    {% if additional_recs %}
    <section class="card">
      <h2>üìö G·ª£i √Ω c√°c m√¥n b·ªï sung (H·ªçc k·ª≥ 1 nƒÉm 5)</h2>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 1em;">
        <em>Ph·∫ßn n√†y ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang trang ri√™ng.</em>
      </p>
      <p>
        <a class="button" href="/recommendations/hk1-nam5">Xem c√°c m√¥n b·ªï sung cho HK1 NƒÉm 5 ‚Üí</a>
      </p>
    </section>
    {% endif %}

    {% if other_recs %}
    <section class="card">
      <h2>üìñ G·ª£i √Ω h·ªçc ph·∫ßn ti·∫øp theo</h2>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 1em;">
        <em>G·ª£i √Ω d·ª±a tr√™n l·ªãch s·ª≠ h·ªçc t·∫≠p c·ªßa c√°c sinh vi√™n ƒë√£ t·ªët nghi·ªáp ƒë√∫ng h·∫°n</em>
      </p>
      <table>
        <thead>
          <tr>
            <th>M√£ m√¥n</th>
            <th>T√™n m√¥n h·ªçc</th>
            <th>T√≠n ch·ªâ</th>
            <th>NƒÉm h·ªçc</th>
            <th>H·ªçc k·ª≥</th>
            <th>ƒêi·ªÉm TB</th>
            <th>T·ª∑ l·ªá ƒë·∫≠u</th>
            <th>L√Ω do g·ª£i √Ω</th>
          </tr>
        </thead>
        <tbody>
          {% for r in other_recs %}
          <tr>
            <td><strong>{{ r.CourseCode }}</strong></td>
            <td>{{ r.CourseName }}</td>
            <td>{{ r.Credits }}</td>
            <td>
              {% if r.recommended_year %}
                <strong>NƒÉm {{ r.recommended_year }}</strong>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if r.recommended_semester %}
                <strong>HK{{ r.recommended_semester }}</strong>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if r.avg_score %}
                {{ "%.2f"|format(r.avg_score) }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if r.pass_rate %}
                {{ "%.1f"|format(r.pass_rate) }}%
              {% else %}
                -
              {% endif %}
            </td>
            <td style="font-size: 0.9em; color: #555;">
              {% if r.recommendation_reason %}
                {{ r.recommendation_reason }}
              {% elif r.frequency %}
                ƒê∆∞·ª£c h·ªçc b·ªüi {{ r.frequency }} sinh vi√™n t·ªët nghi·ªáp ƒë√∫ng h·∫°n t∆∞∆°ng t·ª±
              {% else %}
                G·ª£i √Ω d·ª±a tr√™n sinh vi√™n t∆∞∆°ng t·ª±
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
    {% endif %}

    {% if not recs or (not thesis_recs and not additional_recs and not other_recs) %}
    <section class="card">
      <h2>G·ª£i √Ω h·ªçc ph·∫ßn ti·∫øp theo</h2>
      <p class="muted">Kh√¥ng c√≥ g·ª£i √Ω n√†o cho k·ª≥ ti·∫øp theo ho·∫∑c ch∆∞a ƒë·ªß d·ªØ li·ªáu.</p>
    </section>
    {% endif %}
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p><strong>Tr∆∞·ªùng ƒê·∫°i h·ªçc C·∫ßn Th∆° (Can Tho University)</strong></p>
      <p>Khu II, ƒë∆∞·ªùng 3/2, P. Xu√¢n Kh√°nh, Q. Ninh Ki·ªÅu, TP. C·∫ßn Th∆°.</p>
      <p>ƒêi·ªán tho·∫°i: (84-292) 3832663 - (84-292) 3838474; Fax: (84-292) 3838474; Email: dhct@ctu.edu.vn.</p>
    </div>
  </footer>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    {% if courses %}
    // T√≠nh t√≠n ch·ªâ theo h·ªçc k·ª≥
    const semesterData = {};
    {% for c in courses %}
      const key = 'NƒÉm {{ c.Year }} HK{{ c.Semester }}';
      if (!semesterData[key]) {
        semesterData[key] = 0;
      }
      {% if c.Status == 'ƒê√£ h·ªçc' %}
        semesterData[key] += {{ c.Credits or 0 }};
      {% endif %}
    {% endfor %}
    
    // T·∫°o bi·ªÉu ƒë·ªì
    const ctx = document.getElementById('creditsChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(semesterData),
          datasets: [{
            label: 'T√≠n ch·ªâ ƒë√£ h·ªçc',
            data: Object.values(semesterData),
            backgroundColor: 'rgba(31, 92, 169, 0.8)',
            borderColor: 'rgba(31, 92, 169, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Ph√¢n b·ªë t√≠n ch·ªâ theo h·ªçc k·ª≥',
              font: { size: 16, weight: 'bold' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'S·ªë t√≠n ch·ªâ'
              }
            },
            x: {
              title: {
                display: true,
                text: 'H·ªçc k·ª≥'
              }
            }
          }
        }
      });
    }
    {% endif %}
  </script>
</body>
</html>
